{"version":3,"file":"repository-xml-parser.js","sourceRoot":"","sources":["../../../../src/dictionary/parser/fix-repository/repository-xml-parser.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from 'fs'\nimport * as path from 'path'\nimport { SAXParser } from 'sax'\nimport { promisify } from 'util'\nimport { IDictDoneCb, SAXStream } from '../../dict-primitive'\nimport { FixDefinitions } from '../../definition'\nimport { AbbreviationsParser } from './abbreviations-parser'\nimport { BaseParser } from './base-parser'\nimport { ComponentsParser } from './components-parser'\nimport { EnumsParser } from './enums-parser'\nimport { FieldsParser } from './fields-parser'\nimport { MessagesParser } from './messages-parser'\nimport { MsgContentsParser } from './msg-contents-parser'\nimport { Repository } from './repository'\nimport { FixParser } from '../../fix-parser'\nimport { GetJsFixLogger, IJsFixLogger } from '../../../config'\nimport { DataTypesParser } from './data-types-parser'\nimport { ISaxNode } from '../../sax-node'\nimport { VersionUtil } from '../../version-util'\n\nexport class RepositoryXmlParser extends FixParser {\n  public readonly repository: Repository\n  private readonly singlePass = promisify(RepositoryXmlParser.subscribe)\n  private readonly logger: IJsFixLogger\n\n  constructor (public readonly rootPath: string, public readonly getLogger: GetJsFixLogger) {\n    super()\n    this.logger = getLogger('RepositoryXmlParser')\n    this.repository = new Repository(VersionUtil.resolve(this.rootPath), getLogger)\n  }\n\n  private static subscribe (instance: RepositoryXmlParser, saxStream: SAXStream, done: IDictDoneCb): void {\n    let parser: BaseParser\n    let pending: string\n    const saxParser: SAXParser = saxStream._parser\n\n    saxStream.on('error', (e: Error) => {\n      done(e, null)\n    })\n\n    saxStream.on('closetag', (name) => {\n\n      switch (name) {\n        case 'Datatypes':\n        case 'Abbreviations':\n        case 'Messages':\n        case 'MsgContents':\n        case 'Components':\n        case 'Fields':\n        case 'Enums': {\n          if (parser != null) {\n            parser.close(saxParser.line, name)\n            instance.repository.assign(name, parser.data)\n            parser = null\n          }\n          break\n        }\n\n        case 'Datatype':\n        case 'Abbreviation':\n        case 'MsgContent':\n        case 'Field':\n        case 'Enum':\n        case 'Component':\n        case 'Message': {\n          if (parser != null) {\n            parser.close(saxParser.line, name)\n          }\n          break\n        }\n\n        default: {\n          pending = null\n          break\n        }\n      }\n    })\n\n    saxStream.on('text', (t: string) => {\n      t = t.trim()\n      if (pending) {\n        parser.value(saxParser.line, pending, t)\n      }\n    })\n\n    saxStream.on('opentag', (node) => {\n      const saxNode: ISaxNode = node as ISaxNode\n      switch (saxNode.name) {\n        case 'Datatypes': {\n          parser = new DataTypesParser()\n          break\n        }\n\n        case 'Fields': {\n          parser = new FieldsParser()\n          break\n        }\n\n        case 'Enums': {\n          parser = new EnumsParser()\n          break\n        }\n\n        case 'Components': {\n          parser = new ComponentsParser()\n          break\n        }\n\n        case 'Messages': {\n          parser = new MessagesParser()\n          break\n        }\n\n        case 'MsgContents': {\n          parser = new MsgContentsParser()\n          break\n        }\n\n        case 'Abbreviations': {\n          parser = new AbbreviationsParser()\n          break\n        }\n\n        case 'Datatype':\n        case 'Abbreviation':\n        case 'Field':\n        case 'Message':\n        case 'MsgContent':\n        case 'Enum':\n        case 'Component': {\n          if (parser != null) {\n            parser.open(saxParser.line, saxNode)\n          }\n          break\n        }\n\n        default: {\n          pending = saxNode.name\n        }\n      }\n    })\n\n    saxStream.on('ready', () => {\n      if (done) {\n        parser = null\n        done(null, instance.repository.definitions)\n      }\n    })\n  }\n\n  public parse (): Promise<FixDefinitions> {\n    return new Promise<FixDefinitions>(async (accept, reject) => {\n      try {\n        await this.onePass('Datatypes.xml')\n        await this.onePass('Fields.xml')\n        await this.onePass('Enums.xml')\n        await this.onePass('Components.xml')\n        await this.onePass('Messages.xml')\n        await this.onePass('MsgContents.xml')\n        if (this.repository.includesAbbreviations) {\n          await this.onePass('Abbreviations.xml')\n        }\n        accept(this.repository.definitions)\n      } catch (e) {\n        reject(e)\n      }\n    })\n  }\n\n  private async onePass (fileName: string): Promise<any> {\n    const logger = this.logger\n    const fullFileName = path.join(this.rootPath, fileName)\n    const pass: fs.ReadStream = fs.createReadStream(fullFileName)\n    logger.info(`reading ${fullFileName}`)\n    const saxStream: SAXStream = require('sax').createStream(true, {})\n    pass.pipe(saxStream)\n    await this.singlePass(this, saxStream)\n  }\n}\n"]}