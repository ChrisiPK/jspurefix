{"version":3,"file":"http-acceptor.js","sourceRoot":"","sources":["../../../src/transport/http/http-acceptor.ts"],"names":[],"mappings":"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","sourcesContent":["import { MsgTransport } from '../factory'\nimport { FixAcceptor } from '../fix-acceptor'\nimport { IJsFixConfig, IJsFixLogger } from '../../config'\nimport { IFixmlRequest } from '../fixml'\nimport { StringDuplex, FixDuplex } from '../duplex'\nimport { Dictionary } from '../../collections'\n\nimport * as express from 'express'\nimport * as bodyParser from 'body-parser'\nimport * as http from 'http'\nimport { v4 as uuidv4 } from 'uuid'\nimport { inject, injectable } from 'tsyringe'\nimport { DITokens } from '../../runtime/di-tokens'\n\n@injectable()\nexport class HttpAcceptor extends FixAcceptor {\n  private app: express.Express = express()\n  private server: http.Server\n  private readonly logger: IJsFixLogger\n  private readonly router: express.Router\n  private nextId: number = 0\n  private keys: Dictionary<MsgTransport> = new Dictionary()\n\n  constructor (@inject(DITokens.IJsFixConfig) public readonly config: IJsFixConfig) {\n    super(config.description.application)\n    this.logger = config.logFactory.logger(`${config.description.application.name}:HttpAcceptor`)\n    this.logger.info('creating http server')\n    this.router = express.Router()\n    this.router.use(bodyParser.json())\n    this.subscribe()\n    this.app.use('/', this.router)\n  }\n\n  public listen (): void {\n    const app = this.config.description.application\n    const port = app.http.port\n    const logger = this.logger\n    logger.info(`start to listen ${port}`)\n    this.server = this.app.listen(port, () => {\n      logger.info(`app listening at http://localhost:${port}${app.http.uri}`)\n    })\n    this.server.on('error', ((err: Error) => {\n      logger.error(err)\n      this.emit('error', err)\n    }))\n  }\n\n  public close (callback?: (err?: Error) => void): void {\n    const app = this.config.description.application\n    const port = app.http.port\n    this.logger.info(`close listener on port ${port}`)\n    this.server.close(callback)\n  }\n\n  private saveTransport (tid: number, transport: MsgTransport): string {\n    this.transports[tid] = transport\n    const keys: string[] = Object.keys(this.transports)\n    const a = uuidv4()\n    this.keys.addUpdate(a, transport)\n    this.logger.info(`new transport id = ${tid} token = ${a} created total transports = ${keys.length}`)\n    this.emit('transport', transport)\n    return a\n  }\n\n  private harvestTransport (token: string, tid: number): void {\n    delete this.transports[tid]\n    this.keys.remove(token)\n    const keys: string[] = Object.keys(this.transports)\n    this.logger.info(`transport ${tid} ends total transports = ${keys.length}`)\n  }\n\n  private respond (duplex: FixDuplex, res: express.Response, token: string = null): Promise<any> {\n    return new Promise<any>((accept, reject) => {\n      res.setHeader('Content-Type', 'application/json')\n      const timer = setTimeout(() => {\n        const businessReject = `<FIXML><BizMsgRej BizRejRsn=\"4\" Txt=\"no response from application\"/></FIXML>`\n        const b = Buffer.from(businessReject, 'utf-8')\n        duplex.writable.removeListener('data', transmit)\n        res.send(b)\n        reject(new Error('no response'))\n      }, 5000)\n\n      const transmit = (d: Buffer) => {\n        this.logger.info('responding to request')\n        clearTimeout(timer)\n        if (token) {\n          res.setHeader('authorization', token)\n        }\n        duplex.writable.removeListener('data', transmit)\n        res.send(d)\n        accept(true)\n      }\n\n      duplex.writable.on('data', transmit)\n    })\n  }\n\n  private async logon (req: express.Request, res: express.Response) {\n    const body: IFixmlRequest = req.body\n    const id = this.nextId++\n    this.logger.info(JSON.stringify(body, null,4))\n    // check hand back session key\n    const d = new StringDuplex()\n    const transport = new MsgTransport(id, this.config, d)\n    const token = this.saveTransport(id, transport)\n    this.respond(d, res, token).then(() => {\n      this.logger.info('responded to logon')\n    }).catch((e: Error) => {\n      this.logger.error(e)\n    })\n    d.readable.push(body.fixml)\n  }\n\n  private async logout (req: express.Request, res: express.Response) {\n    const headers = req.headers\n    const body: IFixmlRequest = req.body\n    const t: MsgTransport = this.keys.get(headers.authorization)\n    if (t) {\n      const token = req.headers.authorization\n      this.harvestTransport(token, t.id)\n      const d = t.duplex\n      this.respond(d, res, token).then(() => {\n        this.logger.info('responded to logout')\n        t.end()\n      }).catch((e: Error) => {\n        this.logger.error(e)\n      })\n      d.readable.push(body.fixml)\n    }\n  }\n\n  private subscribe (): void {\n    const router = this.router\n    const app = this.config.description.application\n    const root = app.http.uri\n    const authorise = `${root}authorise`\n    const query = `${root}query`\n    this.logger.info(`uri: authorise ${authorise}, query ${query}`)\n    router.post(authorise, async (req: express.Request, res: express.Response) => {\n      if (!req.headers.authorization) {\n        this.logger.info('logon')\n        await this.logon(req, res)\n      } else {\n        this.logger.info('logout')\n        await this.logout(req, res)\n      }\n    })\n\n    router.get(query, async (req: express.Request, res: express.Response) => {\n      const headers = req.headers\n      const body: IFixmlRequest = req.body\n      const t: MsgTransport = this.keys.get(headers.authorization)\n      if (!t) {\n        this.logger.info(`received request with no token`)\n        res.send({\n          error: 'no key with query'\n        })\n      } else {\n        const d = t.duplex\n        this.respond(d, res).then(() => {\n          this.logger.info(`responded to ${req.url}`)\n        }).catch(e => {\n          res.send(e)\n        })\n        d.readable.push(body.fixml)\n      }\n    })\n  }\n}\n"]}