{"version":3,"file":"tcp-acceptor-listener.js","sourceRoot":"","sources":["../../../src/transport/tcp/tcp-acceptor-listener.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAEA,iDAA4C;AAE5C,uCAA6C;AAE7C,uDAAkD;AAClD,8CAAyC;AAGlC,IAAM,mBAAmB,GAAzB,MAAM,mBAAoB,SAAQ,sBAAS;IAChD,YAA4D,MAAoB;QAC9E,KAAK,CAAC,MAAM,CAAC,CAAA;QAD6C,WAAM,GAAN,MAAM,CAAc;IAEhF,CAAC;IAED,KAAK;QACH,OAAO,IAAI,OAAO,CAAM,CAAO,MAAM,EAAE,MAAM,EAAE,EAAE;YAC/C,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,UAAU,CAAC,CAAA;YACxD,MAAM,gBAAgB,GAAG,IAAI,CAAC,MAAM,CAAC,gBAAgB,CAAA;YACrD,IAAI,CAAC,gBAAgB,CAAC,YAAY,CAAC,oBAAQ,CAAC,UAAU,CAAC,EAAE;gBACvD,MAAM,CAAC,IAAI,KAAK,CAAC,yCAAyC,oBAAQ,CAAC,UAAU,oBAAoB,CAAC,CAAC,CAAA;aACpG;YACD,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAA;YACxB,MAAM,QAAQ,GAAgB,gBAAgB,CAAC,OAAO,CAAc,0BAAW,CAAC,CAAA;YAChF,QAAQ,CAAC,EAAE,CAAC,WAAW,EAAE,CAAC,CAAe,EAAE,EAAE;gBAC3C,MAAM,CAAC,IAAI,CAAC,wCAAwC,oBAAQ,CAAC,UAAU,GAAG,CAAC,CAAA;gBAC3E,MAAM,eAAe,GAAG,gBAAgB,CAAC,OAAO,CAAa,oBAAQ,CAAC,UAAU,CAAC,CAAA;gBACjF,eAAe,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,EAAE;oBAC/B,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAA;oBACnB,QAAQ,CAAC,KAAK,CAAC,GAAG,EAAE;wBAClB,MAAM,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAA;wBAC/B,MAAM,CAAC,IAAI,CAAC,CAAA;oBACd,CAAC,CAAC,CAAA;gBACJ,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAQ,EAAE,EAAE;oBACpB,MAAM,CAAC,IAAI,CAAC,qCAAqC,CAAC,CAAC,OAAO,EAAE,CAAC,CAAA;oBAC7D,QAAQ,CAAC,KAAK,CAAC,GAAG,EAAE;wBAClB,MAAM,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAA;wBAC/B,MAAM,CAAC,CAAC,CAAC,CAAA;oBACX,CAAC,CAAC,CAAA;gBACJ,CAAC,CAAC,CAAA;YACJ,CAAC,CAAC,CAAA;YACF,QAAQ,CAAC,MAAM,EAAE,CAAA;QACnB,CAAC,CAAA,CAAC,CAAA;IACJ,CAAC;CACF,CAAA;AAlCY,mBAAmB;IAD/B,IAAA,qBAAU,GAAE;IAEG,WAAA,IAAA,iBAAM,EAAC,oBAAQ,CAAC,YAAY,CAAC,CAAA;;GADhC,mBAAmB,CAkC/B;AAlCY,kDAAmB","sourcesContent":["import { IJsFixConfig } from '../../config'\nimport { FixAcceptor } from '../fix-acceptor'\nimport { TcpAcceptor } from './tcp-acceptor'\nimport { MsgTransport } from '../factory'\nimport { inject, injectable } from 'tsyringe'\nimport { FixSession } from '../session/fix-session'\nimport { DITokens } from '../../runtime/di-tokens'\nimport { FixEntity } from '../fix-entity'\n\n@injectable()\nexport class TcpAcceptorListener extends FixEntity {\n  constructor (@inject(DITokens.IJsFixConfig) public readonly config: IJsFixConfig) {\n    super(config)\n  }\n\n  start (): Promise<any> {\n    return new Promise<any>(async (accept, reject) => {\n      const logger = this.config.logFactory.logger('acceptor')\n      const sessionContainer = this.config.sessionContainer\n      if (!sessionContainer.isRegistered(DITokens.FixSession)) {\n        reject(new Error(`application must register a DI token '${DITokens.FixSession}' - see src/sample`))\n      }\n      logger.info('starting.')\n      const acceptor: FixAcceptor = sessionContainer.resolve<FixAcceptor>(TcpAcceptor)\n      acceptor.on('transport', (t: MsgTransport) => {\n        logger.info(`creates new transport using DI token ${DITokens.FixSession}.`)\n        const acceptorSession = sessionContainer.resolve<FixSession>(DITokens.FixSession)\n        acceptorSession.run(t).then(() => {\n          logger.info('ends')\n          acceptor.close(() => {\n            logger.info('acceptor closed.')\n            accept(true)\n          })\n        }).catch((e: Error) => {\n          logger.info(`error in session - close listener ${e.message}`)\n          acceptor.close(() => {\n            logger.info('acceptor closed.')\n            reject(e)\n          })\n        })\n      })\n      acceptor.listen()\n    })\n  }\n}\n"]}