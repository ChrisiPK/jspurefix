{"version":3,"file":"memory-store.test.js","sourceRoot":"","sources":["../../../src/test/ascii/memory-store.test.ts"],"names":[],"mappings":"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","sourcesContent":["import 'reflect-metadata'\n\nimport * as path from 'path'\nimport { FixDefinitions } from '../../dictionary/definition'\nimport { MsgView } from '../../buffer'\nimport { AsciiView } from '../../buffer/ascii'\nimport { ILooseObject } from '../../collections/collection'\nimport { FixMsgMemoryStore, FixMsgStoreRecord, IFixMsgStore } from '../../store'\nimport { MsgTag } from '../../types'\nimport { Setup } from '../env/setup'\n\nconst root: string = path.join(__dirname, '../../../data')\n\nlet definitions: FixDefinitions\nlet views: MsgView[]\nlet expected: ILooseObject\nlet store: IFixMsgStore\nlet records: FixMsgStoreRecord[]\nlet setup: Setup = null\n\nbeforeAll(async () => {\n  setup = new Setup('session/test-initiator.json',null)\n  await setup.init()\n  definitions = setup.clientConfig.definitions\n  expected = require(path.join(root, 'examples/FIX.4.4/fix.json'))\n  views = await setup.client.replayer.replayFixFile(path.join(root, 'examples/FIX.4.4/jsfix.test_client.txt'))\n  store = new FixMsgMemoryStore('test', setup.clientConfig)\n  records = views.reduce((agg: FixMsgStoreRecord[], v: AsciiView) => {\n    if (v.getString(MsgTag.SenderCompID) === 'accept-comp') {\n      agg.push(FixMsgStoreRecord.toMsgStoreRecord(v))\n    }\n    return agg\n  }, [])\n  const toWrite = records.map(r => store.put(r))\n  await Promise.all(toWrite)\n}, 45000)\n\ntest('expect 15 messages in log', () => {\n  expect(views.length).toEqual(15)\n})\n\n/*\n8=FIX4.4|9=000112|35=AQ|49=accept-tls-comp|56=init-tls-comp|34=2|57=fix|52=20210307-16:16:44.429|568=all-trades|569=0|749=0|750=0|10=142|\n8=FIX4.4|9=000209|35=AE|49=accept-tls-comp|56=init-tls-comp|34=3|57=fix|52=20210307-16:16:44.430|571=100000|487=0|856=0|828=0|17=600000|39=2|570=N|55=Platinum|48=Platinum.INC|32=172|31=7.36|75=20210307|60=20210307-16:16:44.430|10=043|\n8=FIX4.4|9=000202|35=AE|49=accept-tls-comp|56=init-tls-comp|34=4|57=fix|52=20210307-16:16:44.431|571=100001|487=0|856=0|828=0|17=600001|39=2|570=N|55=Gold|48=Gold.INC|32=175|31=83.67|75=20210307|60=20210307-16:16:44.430|10=219|\n8=FIX4.4|9=000210|35=AE|49=accept-tls-comp|56=init-tls-comp|34=5|57=fix|52=20210307-16:16:44.432|571=100002|487=0|856=0|828=0|17=600002|39=2|570=N|55=Platinum|48=Platinum.INC|32=146|31=41.79|75=20210307|60=20210307-16:16:44.430|10=097|\n8=FIX4.4|9=000211|35=AE|49=accept-tls-comp|56=init-tls-comp|34=6|57=fix|52=20210307-16:16:44.432|571=100003|487=0|856=0|828=0|17=600003|39=2|570=N|55=Magnesium|48=Magnesium.INC|32=156|31=8.02|75=20210307|60=20210307-16:16:44.430|10=227|\n8=FIX4.4|9=000202|35=AE|49=accept-tls-comp|56=init-tls-comp|34=7|57=fix|52=20210307-16:16:44.432|571=100004|487=0|856=0|828=0|17=600004|39=2|570=N|55=Gold|48=Gold.INC|32=136|31=32.13|75=20210307|60=20210307-16:16:44.430|10=211|\n8=FIX4.4|9=000112|35=AQ|49=accept-tls-comp|56=init-tls-comp|34=8|57=fix|52=20210307-16:16:44.433|568=all-trades|569=0|749=0|750=1|10=144|\n8=FIX4.4|9=000202|35=AE|49=accept-tls-comp|56=init-tls-comp|34=9|57=fix|52=20210307-16:16:59.449|571=100005|487=0|856=0|828=0|17=600005|39=2|570=N|55=Gold|48=Gold.INC|32=166|31=53.91|75=20210307|60=20210307-16:16:59.449|10=001|\n8=FIX4.4|9=000206|35=AE|49=accept-tls-comp|56=init-tls-comp|34=10|57=fix|52=20210307-16:17:14.477|571=100006|487=0|856=0|828=0|17=600006|39=2|570=N|55=Silver|48=Silver.INC|32=105|31=61.2|75=20210307|60=20210307-16:17:14.477|10=191|\n */\n\ntest('check messages loaded into store', async () => {\n  const state = await store.getState()\n  expect(state.lastSeq).toEqual(10)\n  expect(state.length).toEqual(9)\n})\n\ntest('fetch sequence number from store', async () => {\n  const res1 = await store.exists(1)\n  expect(res1).toBeFalsy()\n  for (let seq = 2; seq <= 10; ++seq) {\n    const res = await store.exists(seq)\n    expect(res).toBeTruthy()\n    const get = await store.get(seq)\n    expect(get).toBeTruthy()\n  }\n})\n\ntest('fetch from seqNum to inferred as end ', async () => {\n  const range1 = await store.getSeqNumRange(5) // to the end\n  expect(range1.length).toEqual(6)\n  expect(range1[0].seqNum).toEqual(5)\n  expect(range1[range1.length - 1].seqNum).toEqual(10)\n})\n\ntest('fetch from seqNum to = start', async () => {\n  const range1 = await store.getSeqNumRange(5, 5)\n  expect(range1.length).toEqual(1)\n  expect(range1[0].seqNum).toEqual(5)\n})\n\ntest('fetch start from seqNum not in store', async () => {\n  const range1 = await store.getSeqNumRange(1)\n  expect(range1.length).toEqual(9)\n  expect(range1[0].seqNum).toEqual(2)\n  expect(range1[range1.length - 1].seqNum).toEqual(10)\n})\n"]}