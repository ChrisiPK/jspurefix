{"version":3,"file":"ascii-view.js","sourceRoot":"","sources":["../../../src/buffer/ascii/ascii-view.ts"],"names":[],"mappings":"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","sourcesContent":["import { SimpleFieldDefinition } from '../../dictionary/definition'\nimport { SegmentDescription } from '../segment/segment-description'\nimport { Structure } from '../structure'\nimport { MsgView } from '../msg-view'\nimport { ElasticBuffer } from '../elastic-buffer'\nimport { ITimeFormatter } from './itime-formatter'\nimport { TimeFormatter } from './time-formatter'\nimport { TagPos } from '../tag/tag-pos'\nimport { MsgTag } from '../../types'\nimport { TagType } from '../tag/tag-type'\n\nexport class AsciiView extends MsgView {\n  private readonly timeFormatter: ITimeFormatter = new TimeFormatter(this.buffer)\n  constructor (public readonly segment: SegmentDescription,\n               public readonly buffer: ElasticBuffer,\n               public readonly structure: Structure,\n               public readonly ptr: number,\n               public readonly delimiter: number,\n               public readonly writeDelimiter: number) {\n\n    super(segment, structure)\n  }\n\n  // if the view is to be kept beyond the event on which it arrives, must be cloned\n  public clone (): MsgView {\n    const structure = this.structure\n    const buffer = this.buffer.clone()\n    const segment = this.segment\n    const delimiter = this.delimiter\n    const writeDelimiter = this.writeDelimiter\n    if (structure) {\n      return new AsciiView(segment, buffer, new Structure(structure.tags.clone(), structure.segments), this.ptr, delimiter, writeDelimiter)\n    }\n    return new AsciiView(segment, buffer, null, this.ptr, delimiter, writeDelimiter)\n  }\n\n  private replaceDelimiter (viewBuffer: Buffer, replaceDelimiter?: number): void {\n    const delimiter = replaceDelimiter ?? this.delimiter\n    if (delimiter !== this.writeDelimiter) {\n      const structure = this.structure\n      const tags = structure.tags.tagPos\n      for (let i = 0; i < structure.tags.nextTagPos; ++i) {\n        const tag: TagPos = tags[i]\n        const p: number = tag.start + tag.len\n        viewBuffer.writeUInt8(delimiter, p)\n      }\n    }\n  }\n\n  // turn our view back to a raw msg\n  public toBuffer (replaceDelimiter?: number): Buffer {\n    const viewBuffer = this.buffer.slice()\n    this.replaceDelimiter(viewBuffer, replaceDelimiter)\n    return viewBuffer\n  }\n\n  public checksum (): number {\n    const t = this.getPosition(MsgTag.CheckSum)\n    const structure = this.structure\n    const prev = structure.tags.tagPos[t - 1]\n    const tp = prev.start + prev.len + 1\n    let cs = this.buffer.sum(tp)\n    const delimiter = this.delimiter\n    const writeDelimiter = this.writeDelimiter\n    if (writeDelimiter !== delimiter) {\n      const changes = structure.tags.nextTagPos - 1\n      cs -= changes * writeDelimiter\n      cs += changes * delimiter\n    }\n    return cs % 256\n  }\n\n  protected toTyped (field: SimpleFieldDefinition): any {\n    const position: number = this.getPosition(field.tag)\n    if (position >= 0) {\n      switch (field.tagType) {\n        case TagType.String : {\n          return this.stringAtPosition(position)\n        }\n\n        case TagType.Float: {\n          return this.getNumber(position, true)\n        }\n\n        case TagType.Int:\n        case TagType.Length: {\n          return this.getNumber(position)\n        }\n\n        case TagType.Boolean: {\n          return this.getBoolean(field.tag)\n        }\n\n        case TagType.UtcTimestamp: {\n          return this.getDateTime(field.tag, true)\n        }\n\n        case TagType.UtcTimeOnly: {\n          return this.getTime(field.tag, true)\n        }\n\n        case TagType.UtcDateOnly: {\n          return this.getDate(field.tag, true)\n        }\n\n        case TagType.LocalDate: {\n          return this.getDate(field.tag, true)\n        }\n\n        case TagType.RawData: {\n          return this.getBuffer(position)\n        }\n\n        default: {\n          return this.stringAtPosition(position)\n        }\n      }\n    }\n  }\n\n  protected create (singleton: SegmentDescription): MsgView {\n    return new AsciiView(singleton,\n      this.buffer,\n      this.structure,\n      this.ptr,\n      this.delimiter,\n      this.writeDelimiter)\n  }\n\n  protected stringAtPosition (position: number): string {\n    const tags = this.structure.tags\n    if (position < 0 || position >= tags.nextTagPos) {\n      return null\n    }\n    const tag: TagPos = tags.tagPos[position]\n    return this.buffer.getString(tag.start, tag.start + tag.len)\n  }\n\n  private getBuffer (position: number): Buffer {\n    const tag: TagPos = this.structure.tags.tagPos[position]\n    return this.buffer.getBuffer(tag.start, tag.start + tag.len)\n  }\n\n  private getNumber (position: number, isFloat: boolean = false): number {\n    const buffer = this.buffer\n    const tag: TagPos = this.structure.tags.tagPos[position]\n    if (isFloat) {\n      return buffer.getFloat(tag.start, tag.start + tag.len - 1)\n    } else {\n      return buffer.getWholeNumber(tag.start, tag.start + tag.len - 1)\n    }\n  }\n\n  private getTime (tag: number, useUtc: boolean): Date {\n    const formatter = this.timeFormatter\n    const position: number = this.getPosition(tag)\n    const tagPos: TagPos = this.structure.tags.tagPos[position]\n    if (position < 0) {\n      return null\n    }\n    if (useUtc) {\n      return formatter.getUtcTime(tagPos.start)\n    } else {\n      return formatter.getLocalTime(tagPos.start)\n    }\n  }\n\n  private getDate (tag: number, useUtc: boolean): Date {\n    const formatter = this.timeFormatter\n    const position: number = this.getPosition(tag)\n    if (position < 0) {\n      return null\n    }\n    const tagPos: TagPos = this.structure.tags.tagPos[position]\n    // (SendingTime) = 20150417-01:00:08.201\n    if (tagPos.len < 8) {\n      return null\n    }\n    if (useUtc) {\n      return formatter.getUtcDate(tagPos.start)\n    } else {\n      return formatter.getLocalDate(tagPos.start)\n    }\n  }\n\n  private getDateTime (tag: number, useUtc: boolean): Date {\n    const position: number = this.getPosition(tag)\n    const tagPos: TagPos = this.structure.tags.tagPos[position]\n    const formatter = this.timeFormatter\n    if (position < 0) {\n      return null\n    }\n        // (SendingTime) = 20150417-01:00:08.201\n    if (tagPos.len < 8) {\n      return null\n    }\n\n    if (useUtc) {\n      return formatter.getUtcTimestamp(tagPos.start, tagPos.start + tagPos.len)\n    } else {\n      return formatter.getLocalTimestamp(tagPos.start, tagPos.start + tagPos.len)\n    }\n  }\n\n  private getBoolean (tag: number): boolean {\n    const position: number = this.getPosition(tag)\n    if (position < 0) {\n      return null\n    }\n    const tagPos: TagPos = this.structure.tags.tagPos[position]\n    return this.buffer.getBoolean(tagPos.start)\n  }\n}\n"]}