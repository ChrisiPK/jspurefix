{"version":3,"file":"trade-capture-server.js","sourceRoot":"","sources":["../../../../src/sample/tcp/trade-capture/trade-capture-server.ts"],"names":[],"mappings":"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","sourcesContent":["import { MsgView } from '../../../buffer'\nimport { AsciiSession } from '../../../transport'\nimport { MsgType } from '../../../types'\nimport { IJsFixLogger, IJsFixConfig } from '../../../config'\n// interfaces generated by compiler to make messages easy in an IDE\nimport { ITradeCaptureReportRequest, ITradeCaptureReport, MsgTag, SessionRejectReason,\n  SubscriptionRequestType, TradeRequestStatus } from '../../../types/FIX4.4/repo'\nimport { TradeFactory } from './trade-factory'\n\nexport class TradeCaptureServer extends AsciiSession {\n  private readonly logger: IJsFixLogger\n  private readonly fixLog: IJsFixLogger\n  private readonly tradeFactory: TradeFactory = new TradeFactory()\n  private timerHandle: NodeJS.Timer = null\n\n  constructor (public readonly config: IJsFixConfig) {\n    super(config)\n    this.logReceivedMsgs = true\n    this.logger = config.logFactory.logger(`${this.me}:TradeCaptureServer`)\n    this.fixLog = config.logFactory.plain(`jsfix.${config.description.application.name}.txt`)\n  }\n\n  protected onApplicationMsg (msgType: string, view: MsgView): void {\n    this.logger.info(`${view.toJson()}`)\n    switch (msgType) {\n      case MsgType.TradeCaptureReportRequest: {\n        this.tradeCaptureReportRequest(view.toObject())\n        break\n      }\n\n      default: {\n        const seqNum = view.getTyped(MsgTag.MsgSeqNum)\n        this.send(msgType, this.config.factory.reject(msgType, seqNum, `${this.me}: unexpected msg type '${msgType}'`, SessionRejectReason.InvalidMsgType))\n        break\n      }\n    }\n  }\n\n  protected onReady (view: MsgView): void {\n    // server waits for client to make a request\n    this.logger.info('ready for requests.')\n  }\n\n  protected onStopped (): void {\n    this.logger.info('stopped')\n    if (this.timerHandle) {\n      clearInterval(this.timerHandle)\n    }\n  }\n\n  protected onLogon (view: MsgView, user: string, password: string): boolean {\n    return true\n  }\n\n  // use msgType for example to persist only trade capture messages to database\n  protected onDecoded (msgType: string, txt: string): void {\n    this.fixLog.info(txt)\n  }\n\n  // delimiter substitution now done in encoding\n  protected onEncoded (msgType: string, txt: string): void {\n    this.fixLog.info(txt)\n  }\n\n  private tradeCaptureReportRequest (tcr: ITradeCaptureReportRequest): void {\n    this.logger.info(`received tcr ${tcr.TradeRequestID}`)\n    // send back an ack.\n    this.send(MsgType.TradeCaptureReportRequestAck, TradeFactory.tradeCaptureReportRequestAck(tcr, TradeRequestStatus.Accepted))\n    // send some trades\n    const batch: ITradeCaptureReport[] = this.tradeFactory.batchOfTradeCaptureReport(5)\n    batch.forEach((tc: ITradeCaptureReport) => {\n      this.send(MsgType.TradeCaptureReport, tc)\n    })\n    this.send(MsgType.TradeCaptureReportRequestAck, TradeFactory.tradeCaptureReportRequestAck(tcr, TradeRequestStatus.Completed))\n    // start sending the odd 'live' trade\n    switch (tcr.SubscriptionRequestType) {\n      case SubscriptionRequestType.SnapshotAndUpdates: {\n        this.timerHandle = setInterval(() => {\n          if (Math.random() < 0.4) {\n            const tc: ITradeCaptureReport = this.tradeFactory.singleTradeCaptureReport()\n            this.send(MsgType.TradeCaptureReport, tc)\n          }\n        }, 5000)\n        break\n      }\n    }\n  }\n}\n"]}